<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTU Robotics Club QR Scanner (Universal Scanning & Sectioned Reports)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; margin: 0; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        #section-selector { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1.1em; }
        #video-container { width: 100%; max-width: 500px; position: relative; background: #000; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        video { width: 100%; display: block; border-radius: 8px; }
        #result-container { margin-top: 20px; padding: 15px; min-height: 50px; width: 100%; max-width: 500px; text-align: center; border-radius: 8px; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s, color 0.3s; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        p { margin: 5px 0 0 0; font-weight: normal; font-size: 0.9em; }
        .buttons-group { display: flex; gap: 10px; margin-top: 20px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        label { font-weight: bold; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>GTU Robotics Club QR Code Attendance Scanner</h1>
    
    <label for="section-selector">Select Section for Report:</label>
    <select id="section-selector">
        <option value="Management">Management Section</option>
        <option value="Mechanical">Mechanical Section</option>
        <option value="Circuitry">Circuitry Section</option>
    </select>
    
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <div id="result-container">Scan a QR code to mark attendance...</div>

    <div class="buttons-group">
        <button onclick="downloadSectionReport()">Download Section Report (PDF)</button>
        <button onclick="clearAttendanceHistory()" style="background-color: #dc3545;">Clear All History</button>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const resultContainer = document.getElementById('result-container');
        const sectionSelector = document.getElementById('section-selector');
        
        let lastScanTime = 0;
        let lastScannedId = null;
        const SCAN_COOLDOWN = 3000; // 3 seconds cooldown
        
        // --- ðŸ”‘ PERSISTENT DATA ARRAY ---
        let ATTENDANCE_HISTORY = [];
        const STORAGE_KEY = 'GRC_ATTENDANCE_LOG';
        
        // --- STUDENT DATA Grouped by Section ---
        const STUDENTS_DATA = {
            "Management": [
                {"enrollmentNumber": "26GRC227", "name": "Aryan Desai"},
                {"enrollmentNumber": "26GRC228", "name": "Pranav Jain"},
                {"enrollmentNumber": "26GRC235", "name": "Geetesh mahajan"},
                {"enrollmentNumber": "26GRC236", "name": "Manav Jogendra Sharma"},
                {"enrollmentNumber": "26GRC237", "name": "PRAJVAL DAVRA"},
                {"enrollmentNumber": "26GRC244", "name": "Krish savani"},
                {"enrollmentNumber": "26GRC245", "name": "Vidhaan Mahendra Prajapati"},
                {"enrollmentNumber": "26GRC248", "name": "Dev Prashantbhai Chokshi"},
                {"enrollmentNumber": "26GRC272", "name": "Dave Shiv"},
                {"enrollmentNumber": "26GRC333", "name": "MohammadSuhan Salim Halepotra"},
                {"enrollmentNumber": "26GRC334", "name": "Dhruvesh Patel"},
                {"enrollmentNumber": "26GRC504", "name": "Vishvesh K. Solanki"}
            ],
            "Mechanical": [
                {"enrollmentNumber": "26GRC267", "name": "Chauhan Hitesh Manojbhai"},
                {"enrollmentNumber": "26GRC268", "name": "Thakur Harsh Raj Mukund"},
                {"enrollmentNumber": "26GRC269", "name": "Savaliya Dhyey"},
                {"enrollmentNumber": "26GRC270", "name": "Kachhadiya Harmin Bharat Bhai"},
                {"enrollmentNumber": "26GRC276", "name": "Dev Rajkamal"},
                {"enrollmentNumber": "26GRC278", "name": "Patel Prince Mukeshbhai"},
                {"enrollmentNumber": "26GRC283", "name": "Thummar Ayush"},
                {"enrollmentNumber": "26GRC282", "name": "Dhruviil Panchal"},
                {"enrollmentNumber": "26GRC285", "name": "Dhruv Udaybhai Zala"},
                {"enrollmentNumber": "26GRC287", "name": "Panchal Harshkumar bharatbhai"},
                {"enrollmentNumber": "26GRC293", "name": "Raval Hariom Bhaveshbhai"},
                {"enrollmentNumber": "26GRC300", "name": "Zaid Haidermiya Saiyad"},
                {"enrollmentNumber": "26GRC302", "name": "Paida Harsh"},
                {"enrollmentNumber": "26GRC303", "name": "Patel Shubh Vishnubhai"},
                {"enrollmentNumber": "26GRC304", "name": "Taksh Hemal Pandya"},
                {"enrollmentNumber": "26GRC309", "name": "Parmar Darshan"},
                {"enrollmentNumber": "26GRC326", "name": "Prajapati Om Sunnykumar"},
                {"enrollmentNumber": "26GRC330", "name": "Tejas Rajnikant Sathawara"}
            ],
            "Circuitry": [
                {"enrollmentNumber": "26GRC001", "name": "Joshi Om Dharmeshbhai"},
                {"enrollmentNumber": "26GRC002", "name": "Patadiya Dhairya Kamleshbhai"},
                {"enrollmentNumber": "26GRC003", "name": "Patel Darsh Mahendra bhai"},
                {"enrollmentNumber": "26GRC006", "name": "Dhruvin Gunjariya"},
                {"enrollmentNumber": "26GRC008", "name": "Mavadiya Nakul Jayeshbhai"},
                {"enrollmentNumber": "26GRC010", "name": "Sudani Harsh Rasikbhai"},
                {"enrollmentNumber": "26GRC011", "name": "Aayush Pareshbhai Prajapati"},
                {"enrollmentNumber": "26GRC013", "name": "PATEL SHLOK BHUPENDRA KUMAR"},
                {"enrollmentNumber": "26GRC023", "name": "Aditya Singh"},
                {"enrollmentNumber": "26GRC026", "name": "Zeel Manojbhai Thummar"},
                {"enrollmentNumber": "26GRC027", "name": "KASWALA YASH PRAKASHBHAI"},
                {"enrollmentNumber": "26GRC028", "name": "Akshita Rajesh Sharma"},
                {"enrollmentNumber": "26GRC030", "name": "RIBADIYA MILAN PARESHBHAI"},
                {"enrollmentNumber": "26GRC032", "name": "Gondaliya Devamkumar Girishbhai"},
                {"enrollmentNumber": "26GRC033", "name": "Pawar Shivani Rajendrasingh"},
                {"enrollmentNumber": "26GRC036", "name": "Parmar drashti shaileshbhai"},
                {"enrollmentNumber": "26GRC038", "name": "Dhruvisha Agja"},
                {"enrollmentNumber": "26GRC041", "name": "ZALA Milandipsinh Mahobatsinh"},
                {"enrollmentNumber": "26GRC047", "name": "DHAMELIYA TAKSH BHAGWATIBHAI"},
                {"enrollmentNumber": "26GRC048", "name": "Sagar Borole"},
                {"enrollmentNumber": "26GRC049", "name": "SHEKHAR PRADHAN"},
                {"enrollmentNumber": "26GRC051", "name": "Fenil Pravinbhai Patel"},
                {"enrollmentNumber": "26GRC054", "name": "Parmar vedant Jaydeepbhai"},
                {"enrollmentNumber": "26GRC055", "name": "rushabh jadav"},
                {"enrollmentNumber": "26GRC057", "name": "Rathod Kashish Vinodbhai"},
                {"enrollmentNumber": "26GRC058", "name": "Mridul Mithilesh Shukla"},
                {"enrollmentNumber": "26GRC059", "name": "Daksh Mehta"},
                {"enrollmentNumber": "26GRC064", "name": "Joshi Rishi Brijesh"},
                {"enrollmentNumber": "26GRC066", "name": "Harshul shah"},
                {"enrollmentNumber": "26GRC071", "name": "Patel Raj Rakeshbhai"},
                {"enrollmentNumber": "26GRC072", "name": "Mariya Fakih"},
                {"enrollmentNumber": "26GRC075", "name": "Aditya Mehulbhai Parekh"},
                {"enrollmentNumber": "26GRC077", "name": "Yash Sunil Singh"},
                {"enrollmentNumber": "26GRC080", "name": "TIRTH MODI"},
                {"enrollmentNumber": "26GRC095", "name": "Abdul Qadir Fakharuddin Subedar"},
                {"enrollmentNumber": "26GRC098", "name": "Samarth Vyas"},
                {"enrollmentNumber": "26GRC104", "name": "Gadariya Koshal"},
                {"enrollmentNumber": "26GRC108", "name": "Arjun Singh"},
                {"enrollmentNumber": "26GRC110", "name": "Himanshu Kiran Patil"},
                {"enrollmentNumber": "26GRC111", "name": "Panchal Anjali Rupeshbhai"},
                {"enrollmentNumber": "26GRC115", "name": "Kaushik harsh sanjay kumar"},
                {"enrollmentNumber": "26GRC117", "name": "Lakhani Kanishk Nikhilbhai"},
                {"enrollmentNumber": "26GRC119", "name": "Chauhan rohit ashokbhai"},
                {"enrollmentNumber": "278", "name": "prince patel"},
                {"enrollmentNumber": "26GRC332", "name": "hetal modha"},
                {"enrollmentNumber": "26GRC335", "name": "Kushwaha Nikita Ramesh prasad"},
                {"enrollmentNumber": "26GRC337", "name": "Vikash Kumar Prasad"},
                {"enrollmentNumber": "26GRC339", "name": "dave shivam"},
                {"enrollmentNumber": "26GRC340", "name": "Bhavik Nikunj Ramjiyani"},
                {"enrollmentNumber": "26GRC341", "name": "jigar chaudhary"},
                {"enrollmentNumber": "26GRC342", "name": "ANSHITA CHAUHAN RANJEETSINGH"},
                {"enrollmentNumber": "26GRC343", "name": "het malviya"},
                {"enrollmentNumber": "26GRC345", "name": "ODD NIKULBHAI MAHESHBHAI"},
                {"enrollmentNumber": "26GRC346", "name": "Oza suraj pradipkumar"},
                {"enrollmentNumber": "26GRC347", "name": "Yadav Prajwal Premsagar"},
                {"enrollmentNumber": "26GRC348", "name": "Arya Venkatesh Pandu"},
                {"enrollmentNumber": "26GRC349", "name": "rohit patel"},
                {"enrollmentNumber": "26GRC351", "name": "patel hardik"},
                {"enrollmentNumber": "26GRC352", "name": "patel gresi"},
                {"enrollmentNumber": "26GRC353", "name": "Kavyansh Pandya"},
                {"enrollmentNumber": "26GRC354", "name": "MOHANTY RAJAT SURESHKUMAR"},
                {"enrollmentNumber": "26GRC357", "name": "Parmar Aryan Virabhai"},
                {"enrollmentNumber": "26GRC501", "name": "Shah Daksh Vipulkumar"},
                {"enrollmentNumber": "26GRC503", "name": "Fapale Ishwari Anilbhai"},
                {"enrollmentNumber": "26GRC506", "name": "Anuj Vipul Shah Mall"},
                {"enrollmentNumber": "26GRC507", "name": "rudra puwar"},
                {"enrollmentNumber": "26GRC508", "name": "Khushi Kumari"},
                {"enrollmentNumber": "26GRC513", "name": "GIRI NIKHIL UPENDRA"},
                {"enrollmentNumber": "26GRC514", "name": "saw ranjeet"},
                {"enrollmentNumber": "26GRC517", "name": "chauhan abhishekh"},
                {"enrollmentNumber": "26GRC518", "name": "depani denil"},
                {"enrollmentNumber": "26GRC519", "name": "shrey chaniyara"},
                {"enrollmentNumber": "26GRC522", "name": "Yashvi Ashitbhai Chulawala"},
                {"enrollmentNumber": "26GRC523", "name": "Aryan Tolani"},
                {"enrollmentNumber": "26GRC524", "name": "BADANE TANISH BHAGWAN"},
                {"enrollmentNumber": "26GRC600", "name": "Prajapati Sachinkumar Ashvinbhai"},
                {"enrollmentNumber": "285", "name": "prajapati haresh kumar"},
                {"enrollmentNumber": "509", "name": "saurabh singh"},
                {"enrollmentNumber": "521", "name": "khusli jariwala"},
                {"enrollmentNumber": "601", "name": "pragati sharma"}
            ]
        };

        const STUDENT_MAP = {};
        Object.keys(STUDENTS_DATA).forEach(section => {
            STUDENTS_DATA[section].forEach(student => {
                STUDENT_MAP[student.enrollmentNumber] = {...student, class: section};
            });
        });
        // ----------------------------------------------------------------------

        // --- Persistence Functions ---

        function loadAttendanceHistory() {
            try {
                const storedLog = localStorage.getItem(STORAGE_KEY);
                ATTENDANCE_HISTORY = storedLog ? JSON.parse(storedLog) : [];
            } catch (e) {
                console.error("Failed to load attendance history:", e);
                ATTENDANCE_HISTORY = [];
            }
        }

        function saveAttendanceHistory() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ATTENDANCE_HISTORY));
            } catch (e) {
                console.error("Failed to save attendance history:", e);
            }
        }

        function clearAttendanceHistory() {
            if (confirm("WARNING: This will permanently delete ALL saved attendance data. Are you sure?")) {
                localStorage.removeItem(STORAGE_KEY);
                ATTENDANCE_HISTORY = [];
                updateResultUI({ status: "success", message: "History cleared successfully." });
            }
        }
        
        // --- Core Scanner Logic ---

        async function startScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            } catch (e) {
                console.error("Camera Error:", e);
                resultContainer.innerHTML = '<p class="error">Could not access camera. Please grant permission and refresh.</p>';
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    handleQrCode(code.data.trim());
                }
            }
            requestAnimationFrame(tick);
        }

        // --- Check-In/Check-Out Logic ---
        function handleQrCode(grc_id) {
            const currentTime = Date.now();
            
            // Apply cooldown
            if (currentTime - lastScanTime < SCAN_COOLDOWN && grc_id === lastScannedId) {
                return;
            }
            
            if (!grc_id) {
                updateResultUI({ status: "error", message: "Error: No data detected in QR code. Scan again." });
                return;
            }
            
            lastScanTime = currentTime;
            lastScannedId = grc_id;
            
            const student = STUDENT_MAP[grc_id];
            
            if (!student) {
                // Not a valid student ID
                updateResultUI({
                    status: "Error",
                    message: `âŒ Error: GRC_ID '${grc_id}' not found in the master list.`,
                    grc_id: grc_id,
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }

            // Find the last open check-in entry for this student
            const lastEntryIndex = ATTENDANCE_HISTORY.findIndex(
                entry => entry.grc_id === grc_id && !entry.outTime
            );

            let statusMessage;
            let status;
            const logTimestamp = new Date().toLocaleString(); // Full timestamp for log

            if (lastEntryIndex === -1) {
                // No open entry found -> **CHECK-IN**
                const newEntry = {
                    grc_id: grc_id,
                    name: student.name,
                    className: student.class,
                    inTime: logTimestamp,
                    outTime: null, // Set to null to indicate an open session
                };
                ATTENDANCE_HISTORY.push(newEntry);
                
                statusMessage = `âœ… CHECK-IN successful for ${student.name} (${student.class})`;
                status = "Check-In Success";

            } else {
                // Open entry found -> **CHECK-OUT**
                ATTENDANCE_HISTORY[lastEntryIndex].outTime = logTimestamp;

                statusMessage = `ðŸ‘‹ CHECK-OUT successful for ${student.name} (${student.class})`;
                status = "Check-Out Success";
            }
            
            // Save and Update the display for the user
            saveAttendanceHistory();
            updateResultUI({
                status: status,
                message: statusMessage,
                grc_id: grc_id,
                timestamp: new Date().toLocaleTimeString()
            });
        }

        // Function to update the display message
        function updateResultUI(data) {
            resultContainer.classList.remove("success", "error");

            if (data.status.includes("Success") || data.status.includes("Check-In") || data.status.includes("Check-Out")) {
                resultContainer.classList.add("success");
                resultContainer.innerHTML = `
                    <strong>${data.message}</strong>
                    <p style="margin: 5px 0 0 0;">ID: ${data.grc_id || lastScannedId} | Time: ${data.timestamp}</p>
                `;
            } else {
                resultContainer.classList.add("error");
                resultContainer.innerHTML = `<strong>${data.message}</strong>`;
            }
        }

        // --- ðŸ”‘ PDF Generation Function (Using jsPDF autoTable to fix clipping) ---
        function downloadSectionReport() {
            const selectedSection = sectionSelector.value;
            const date = new Date().toLocaleDateString('en-GB');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Filter the full student list by the selected section
            const sectionStudents = STUDENTS_DATA[selectedSection];
            
            if (!sectionStudents || sectionStudents.length === 0) {
                 alert(`Error: No student data found for the ${selectedSection} section.`);
                 return;
            }
            
            // Prepare data for the autoTable
            const finalReportData = sectionStudents.map(student => {
                // Find the latest attendance entry for this student (for the current status)
                const lastEntry = ATTENDANCE_HISTORY
                    .filter(entry => entry.grc_id === student.enrollmentNumber)
                    .slice(-1)[0]; // Get the last element

                let status = 'ABSENT';
                let inTime = '---';
                let outTime = '---';

                if (lastEntry) {
                    inTime = lastEntry.inTime ? new Date(lastEntry.inTime).toLocaleTimeString() : '---';
                    outTime = lastEntry.outTime ? new Date(lastEntry.outTime).toLocaleTimeString() : '---';
                    status = lastEntry.outTime ? 'PRESENT' : 'ACTIVE (IN)';
                }

                return [
                    student.enrollmentNumber,
                    student.name,
                    inTime,
                    outTime,
                    status
                ];
            }).sort((a, b) => a[1].localeCompare(b[1])); // Sort by Name

            
            // Add Title
            pdf.text(`GTU Robotics Club Attendance - ${selectedSection}`, 14, 15);
            pdf.text(`Report Date: ${date}`, 14, 22);

            // Generate Table using autoTable
            pdf.autoTable({
                startY: 28,
                head: [['ID', 'Name', 'IN Time', 'OUT Time', 'Status']],
                body: finalReportData,
                theme: 'striped',
                headStyles: { fillColor: [0, 123, 255] },
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        // Color the Status column
                        const status = data.cell.text[0];
                        if (data.column.index === 4) { // Status column
                            if (status.includes('ACTIVE')) {
                                data.cell.styles.textColor = [255, 165, 0]; // Orange
                            } else if (status.includes('PRESENT')) {
                                data.cell.styles.textColor = [0, 128, 0]; // Green
                            } else if (status.includes('ABSENT')) {
                                data.cell.styles.textColor = [150, 150, 150]; // Gray
                            }
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });

            // Save the PDF
            pdf.save(`Attendance_Report_${selectedSection}_${date.replace(/\//g, '-')}.pdf`);
        }
        
        // --- Initialization ---
        loadAttendanceHistory();
        startScanner();
    </script>
</body>
</html>
