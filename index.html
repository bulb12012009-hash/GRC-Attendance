<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTU Robotics Club QR Scanner (Local & Persistent)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        /* CSS styles remain the same for aesthetics */
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; margin: 0; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        #video-container { width: 100%; max-width: 500px; position: relative; background: #000; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        video { width: 100%; display: block; border-radius: 8px; }
        #result-container { margin-top: 20px; padding: 15px; min-height: 50px; width: 100%; max-width: 500px; text-align: center; border-radius: 8px; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s, color 0.3s; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        p { margin: 5px 0 0 0; font-weight: normal; font-size: 0.9em; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin-top: 20px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        a { text-decoration: none; }
        
        /* HIDDEN LOG FOR PDF GENERATION */
        #attendance-log { 
            position: absolute; /* Hide but ensure it can be rendered */
            left: -9999px; 
            width: 800px; 
            padding: 10px; 
            background: white; 
            color: black;
            box-shadow: none;
        }

        /* Styling for the PDF data table (Hidden in HTML) */
        #attendance-log table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #attendance-log th, #attendance-log td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 12px; }
        #attendance-log th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>GTU Robotics Club QR Code Attendance Scanner</h1>
    
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <div id="result-container">Scan a QR code to mark attendance...</div>

    <button onclick="downloadReport()">Download Attendance Report (PDF)</button>
    <button onclick="clearAttendanceHistory()" style="background-color: #dc3545;">Clear History (DANGER)</button>
    
    <div id="attendance-log">
        <h2>Attendance Log</h2>
        </div>

    <script>
        const video = document.getElementById('video');
        const resultContainer = document.getElementById('result-container');
        const attendanceLog = document.getElementById('attendance-log');
        
        let lastScanTime = 0;
        let lastScannedId = null;
        const SCAN_COOLDOWN = 3000; // 3 seconds cooldown
        
        // --- ðŸ”‘ PERSISTENT DATA ARRAY ---
        let ATTENDANCE_HISTORY = [];
        const STORAGE_KEY = 'GRC_ATTENDANCE_LOG';
        
        // --- STUDENT DATA (Same as previous step) ---
        const STUDENTS_DATA = [
            {"enrollmentNumber": "26GRC227", "name": "Aryan Desai", "class": "Management"},
            {"enrollmentNumber": "26GRC228", "name": "Pranav Jain", "class": "Management"},
            {"enrollmentNumber": "26GRC235", "name": "Geetesh mahajan", "class": "Management"},
            {"enrollmentNumber": "26GRC236", "name": "Manav Jogendra Sharma", "class": "Management"},
            {"enrollmentNumber": "26GRC237", "name": "PRAJVAL DAVRA", "class": "Management"},
            {"enrollmentNumber": "26GRC244", "name": "Krish savani", "class": "Management"},
            {"enrollmentNumber": "26GRC245", "name": "Vidhaan Mahendra Prajapati", "class": "Management"},
            {"enrollmentNumber": "26GRC248", "name": "Dev Prashantbhai Chokshi", "class": "Management"},
            {"enrollmentNumber": "26GRC272", "name": "Dave Shiv", "class": "Management"},
            {"enrollmentNumber": "26GRC333", "name": "MohammadSuhan Salim Halepotra", "class": "Management"},
            {"enrollmentNumber": "26GRC334", "name": "Dhruvesh Patel", "class": "Management"},
            {"enrollmentNumber": "26GRC504", "name": "Vishvesh K. Solanki", "class": "Management"},
            {"enrollmentNumber": "26GRC267", "name": "Chauhan Hitesh Manojbhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC268", "name": "Thakur Harsh Raj Mukund", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC269", "name": "Savaliya Dhyey", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC270", "name": "Kachhadiya Harmin Bharat Bhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC276", "name": "Dev Rajkamal", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC278", "name": "Patel Prince Mukeshbhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC283", "name": "Thummar Ayush", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC282", "name": "Dhruviil Panchal", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC285", "name": "Dhruv Udaybhai Zala", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC287", "name": "Panchal Harshkumar bharatbhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC293", "name": "Raval Hariom Bhaveshbhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC300", "name": "Zaid Haidermiya Saiyad", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC302", "name": "Paida Harsh", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC303", "name": "Patel Shubh Vishnubhai", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC304", "name": "Taksh Hemal Pandya", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC309", "name": "Parmar Darshan", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC326", "name": "Prajapati Om Sunnykumar", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC330", "name": "Tejas Rajnikant Sathawara", "class": "Mechanical"},
            {"enrollmentNumber": "26GRC001", "name": "Joshi Om Dharmeshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC002", "name": "Patadiya Dhairya Kamleshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC003", "name": "Patel Darsh Mahendra bhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC006", "name": "Dhruvin Gunjariya", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC008", "name": "Mavadiya Nakul Jayeshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC010", "name": "Sudani Harsh Rasikbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC011", "name": "Aayush Pareshbhai Prajapati", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC013", "name": "PATEL SHLOK BHUPENDRA KUMAR", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC023", "name": "Aditya Singh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC026", "name": "Zeel Manojbhai Thummar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC027", "name": "KASWALA YASH PRAKASHBHAI", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC028", "name": "Akshita Rajesh Sharma", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC030", "name": "RIBADIYA MILAN PARESHBHAI", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC032", "name": "Gondaliya Devamkumar Girishbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC033", "name": "Pawar Shivani Rajendrasingh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC036", "name": "Parmar drashti shaileshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC038", "name": "Dhruvisha Agja", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC041", "name": "ZALA Milandipsinh Mahobatsinh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC047", "name": "DHAMELIYA TAKSH BHAGWATIBHAI", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC048", "name": "Sagar Borole", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC049", "name": "SHEKHAR PRADHAN", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC051", "name": "Fenil Pravinbhai Patel", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC054", "name": "Parmar vedant Jaydeepbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC055", "name": "rushabh jadav", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC057", "name": "Rathod Kashish Vinodbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC058", "name": "Mridul Mithilesh Shukla", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC059", "name": "Daksh Mehta", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC064", "name": "Joshi Rishi Brijesh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC066", "name": "Harshul shah", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC071", "name": "Patel Raj Rakeshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC072", "name": "Mariya Fakih", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC075", "name": "Aditya Mehulbhai Parekh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC077", "name": "Yash Sunil Singh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC080", "name": "TIRTH MODI", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC095", "name": "Abdul Qadir Fakharuddin Subedar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC098", "name": "Samarth Vyas", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC104", "name": "Gadariya Koshal", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC108", "name": "Arjun Singh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC110", "name": "Himanshu Kiran Patil", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC111", "name": "Panchal Anjali Rupeshbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC115", "name": "Kaushik harsh sanjay kumar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC117", "name": "Lakhani Kanishk Nikhilbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC119", "name": "Chauhan rohit ashokbhai", "class": "Circuitry"},
            {"enrollmentNumber": "278", "name": "prince patel", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC332", "name": "hetal modha", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC335", "name": "Kushwaha Nikita Ramesh prasad", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC337", "name": "Vikash Kumar Prasad", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC339", "name": "dave shivam", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC340", "name": "Bhavik Nikunj Ramjiyani", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC341", "name": "jigar chaudhary", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC342", "name": "ANSHITA CHAUHAN RANJEETSINGH", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC343", "name": "het malviya", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC345", "name": "ODD NIKULBHAI MAHESHBHAI", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC346", "name": "Oza suraj pradipkumar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC347", "name": "Yadav Prajwal Premsagar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC348", "name": "Arya Venkatesh Pandu", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC349", "name": "rohit patel", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC351", "name": "patel hardik", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC352", "name": "patel gresi", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC353", "name": "Kavyansh Pandya", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC354", "name": "MOHANTY RAJAT SURESHKUMAR", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC357", "name": "Parmar Aryan Virabhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC501", "name": "Shah Daksh Vipulkumar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC503", "name": "Fapale Ishwari Anilbhai", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC506", "name": "Anuj Vipul Shah Mall", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC507", "name": "rudra puwar", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC508", "name": "Khushi Kumari", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC513", "name": "GIRI NIKHIL UPENDRA", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC514", "name": "saw ranjeet", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC517", "name": "chauhan abhishekh", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC518", "name": "depani denil", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC519", "name": "shrey chaniyara", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC522", "name": "Yashvi Ashitbhai Chulawala", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC523", "name": "Aryan Tolani", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC524", "name": "BADANE TANISH BHAGWAN", "class": "Circuitry"},
            {"enrollmentNumber": "26GRC600", "name": "Prajapati Sachinkumar Ashvinbhai", "class": "Circuitry"},
            {"enrollmentNumber": "285", "name": "prajapati haresh kumar", "class": "Circuitry"},
            {"enrollmentNumber": "509", "name": "saurabh singh", "class": "Circuitry"},
            {"enrollmentNumber": "521", "name": "khusli jariwala", "class": "Circuitry"},
            {"enrollmentNumber": "601", "name": "pragati sharma", "class": "Circuitry"}
        ];

        const STUDENT_MAP = STUDENTS_DATA.reduce((map, student) => {
            map[student.enrollmentNumber] = student;
            return map;
        }, {});
        // ----------------------------------------------------------------------

        // --- Persistence Functions ---

        function loadAttendanceHistory() {
            try {
                const storedLog = localStorage.getItem(STORAGE_KEY);
                ATTENDANCE_HISTORY = storedLog ? JSON.parse(storedLog) : [];
            } catch (e) {
                console.error("Failed to load attendance history:", e);
                ATTENDANCE_HISTORY = [];
            }
        }

        function saveAttendanceHistory() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ATTENDANCE_HISTORY));
            } catch (e) {
                console.error("Failed to save attendance history:", e);
            }
        }

        function clearAttendanceHistory() {
            if (confirm("WARNING: This will permanently delete ALL saved attendance data. Are you sure?")) {
                localStorage.removeItem(STORAGE_KEY);
                ATTENDANCE_HISTORY = [];
                renderAttendanceLog();
                updateResultUI({ status: "success", message: "History cleared successfully." });
            }
        }

        // --- Core Scanner Logic ---

        async function startScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            } catch (e) {
                console.error("Camera Error:", e);
                resultContainer.innerHTML = '<p class="error">Could not access camera. Please grant permission and refresh.</p>';
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert", 
                });
                
                if (code) {
                    handleQrCode(code.data.trim());
                }
            }
            requestAnimationFrame(tick);
        }

        // --- ðŸ”‘ NEW: Check-In/Check-Out Logic ---
        function handleQrCode(grc_id) {
            const currentTime = Date.now();
            
            // Apply cooldown
            if (currentTime - lastScanTime < SCAN_COOLDOWN && grc_id === lastScannedId) {
                return;
            }
            
            if (!grc_id) {
                updateResultUI({ status: "error", message: "Error: No data detected in QR code. Scan again." });
                return; 
            }
            
            lastScanTime = currentTime;
            lastScannedId = grc_id;
            
            const student = STUDENT_MAP[grc_id];
            const timestamp = new Date().toLocaleTimeString();
            const logTimestamp = new Date().toLocaleString(); // Full timestamp for log

            if (!student) {
                // Not a valid student ID
                const local_error = {
                    status: "Error",
                    message: `âŒ Error: GRC_ID '${grc_id}' not found in the student list.`,
                    grc_id: grc_id,
                    timestamp: timestamp
                };
                updateResultUI(local_error);
                return;
            }

            // Find the last open check-in entry for this student
            const lastEntryIndex = ATTENDANCE_HISTORY.findIndex(
                entry => entry.grc_id === grc_id && !entry.outTime
            );

            let statusMessage;
            let status;

            if (lastEntryIndex === -1) {
                // No open entry found -> **CHECK-IN**
                const newEntry = {
                    grc_id: grc_id,
                    name: student.name,
                    className: student.class,
                    inTime: logTimestamp,
                    outTime: null, // Set to null to indicate an open session
                };
                ATTENDANCE_HISTORY.push(newEntry);
                
                statusMessage = `âœ… CHECK-IN successful for ${student.name}`;
                status = "Check-In Success";

            } else {
                // Open entry found -> **CHECK-OUT**
                ATTENDANCE_HISTORY[lastEntryIndex].outTime = logTimestamp;

                statusMessage = `ðŸ‘‹ CHECK-OUT successful for ${student.name}`;
                status = "Check-Out Success";
            }
            
            // Save and Re-render the log
            saveAttendanceHistory();
            renderAttendanceLog(); 

            // Update the display for the user
            updateResultUI({ 
                status: status, 
                message: statusMessage, 
                grc_id: grc_id, 
                timestamp: timestamp 
            });
        }

        // Function to update the display message
        function updateResultUI(data) {
            resultContainer.classList.remove("success", "error");

            if (data.status.includes("Success")) {
                resultContainer.classList.add("success");
                resultContainer.innerHTML = `
                    <strong>${data.message}</strong>
                    <p style="margin: 5px 0 0 0;">ID: ${data.grc_id || lastScannedId} | Time: ${data.timestamp}</p>
                `;
            } else {
                resultContainer.classList.add("error");
                resultContainer.innerHTML = `<strong>${data.message}</strong>`;
            }
        }

        // --- ðŸ”‘ NEW: Render the Full Attendance Log (for PDF) ---
        function renderAttendanceLog() {
            // Clear previous log content
            attendanceLog.innerHTML = '<h2>Attendance Log</h2>';

            if (ATTENDANCE_HISTORY.length === 0) {
                attendanceLog.innerHTML += '<p>No attendance records saved yet.</p>';
                return;
            }

            // Create the table structure
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>IN Time</th>
                        <th>OUT Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            // Populate the table rows
            ATTENDANCE_HISTORY.forEach(entry => {
                const row = tbody.insertRow();
                const status = entry.outTime ? 'Completed' : 'Active (Checked In)';
                
                row.innerHTML = `
                    <td>${entry.grc_id}</td>
                    <td>${entry.name}</td>
                    <td>${entry.className}</td>
                    <td>${entry.inTime || 'N/A'}</td>
                    <td>${entry.outTime || '---'}</td>
                    <td style="color: ${entry.outTime ? 'green' : 'orange'}; font-weight: bold;">${status}</td>
                `;
            });

            attendanceLog.appendChild(table);
        }

        // --- PDF Generation Function (Updated to use persistent log) ---
        function downloadReport() {
            const date = new Date().toLocaleDateString('en-GB');

            // 1. Ensure the log is fully rendered and styled for capture
            renderAttendanceLog();
            attendanceLog.style.position = 'static'; // Make it visible for html2canvas
            attendanceLog.style.left = '0';
            
            const logTitle = attendanceLog.querySelector('h2');
            logTitle.textContent = `GTU Robotics Club Attendance Report - ${date}`;

            // 2. Capture the log container (which now contains the full history table)
            html2canvas(attendanceLog, {
                scale: 2 
            }).then(canvas => {
                // 3. Generate PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                // 4. Save and Clean Up
                pdf.save(`Attendance_Report_${date.replace(/\//g, '-')}.pdf`);

                // Restore hidden state and title
                attendanceLog.style.position = 'absolute';
                attendanceLog.style.left = '-9999px';
                logTitle.textContent = `Attendance Log`;
            });
        }

        // --- Initialization ---
        loadAttendanceHistory();
        renderAttendanceLog();
        startScanner();
    </script>
</body>
</html>
